@page "/"
@inject IActivityService ActivityService
@inject IActivityTypeService ActivityTypeService
@inject IExportImportService ExportImportService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation

<PageTitle>Trainer - Health Activity Tracker</PageTitle>

<div class="header-area">
    <h1 class="mb-0 flex-grow-1">Health Activity Tracker</h1>
</div>

<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5>Activity by Goal Duration</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="duration" id="duration24h" @onchange="() => OnDurationChanged(DurationOption.Last24Hours)" checked="@(selectedDuration == DurationOption.Last24Hours)" />
                            <label class="btn btn-outline-primary" for="duration24h">Activity By Last 24 hours</label>
                            
                            <input type="radio" class="btn-check" name="duration" id="duration7d" @onchange="() => OnDurationChanged(DurationOption.Last7Days)" checked="@(selectedDuration == DurationOption.Last7Days)" />
                            <label class="btn btn-outline-primary" for="duration7d">Activity by Last 7 days</label>
                            
                            <input type="radio" class="btn-check" name="duration" id="durationWeek" @onchange="() => OnDurationChanged(DurationOption.Week)" checked="@(selectedDuration == DurationOption.Week)" />
                            <label class="btn btn-outline-primary" for="durationWeek">Activity by Week</label>
                        </div>
                    </div>
                    <canvas id="goalDurationChart" style="width: 100%; height: 400px; max-width: 100%;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Activities</h5>
                    <div class="header-actions">
                        <button class="icon-button" @onclick="AddNewActivity" title="Add new Activity">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                            </svg>
                        </button>
                        <button class="icon-button" @onclick="ExportActivities" title="Export Activities">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M.5 9.9a.5.5 0 0 1 .5.5h2.5a.5.5 0 0 1 0 1H3a1 1 0 0 0-1 1V14a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1v-1.6a.5.5 0 0 1 0-1H15v-1a.5.5 0 0 1 .5-.5h.5a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.5.5H.5a.5.5 0 0 1-.5-.5v-2a.5.5 0 0 1 .5-.5z"/>
                                <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                            </svg>
                        </button>
                        <button class="icon-button" @onclick="ImportActivities" title="Import Activities">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M.5 9.9a.5.5 0 0 1 .5.5h2.5a.5.5 0 0 1 0 1H3a1 1 0 0 0-1 1V14a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1v-1.6a.5.5 0 0 1 0-1H15v-1a.5.5 0 0 1 .5-.5h.5a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.5.5H.5a.5.5 0 0 1-.5-.5v-2a.5.5 0 0 1 .5-.5z"/>
                                <path d="M8.354 1.146a.5.5 0 0 0-.708 0l-3 3a.5.5 0 0 0 .708.708L7.5 2.707V11.5a.5.5 0 0 0 1 0V2.707l2.146 2.147a.5.5 0 0 0 .708-.708l-3-3z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    @if (activities.Any())
                    {
                        <div class="activity-cards-container">
                            @foreach (var activity in activities.OrderByDescending(a => a.When))
                            {
                                <div class="card activity-card mb-3" style="cursor: pointer;" @onclick="() => EditActivity(activity.Id)">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <span class="fw-semibold">@GetActivityTypeName(activity.ActivityTypeId)</span>
                                        <span class="text-muted small">@DateTimeHelper.FormatWhenDateTime(activity.When)</span>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-2">
                                            <strong>@GetAmountDisplay(activity)</strong>
                                        </div>
                                        @if (!string.IsNullOrWhiteSpace(activity.Notes))
                                        {
                                            <div class="activity-notes">@activity.Notes</div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">No activities yet. Click "Add new Activity" to get started.</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<InputFile id="fileInput" accept=".json" style="display: none;" OnChange="HandleFileImport" class="d-none" />

@code {
    private List<Activity> activities = new();
    private List<ActivityType> activityTypes = new();
    private string? chartInstance;
    private DurationOption selectedDuration = DurationOption.Week;
    private bool _isUpdatingChart = false;
    private bool _hasInitialized = false;

    private enum DurationOption
    {
        Last24Hours,
        Last7Days,
        Week
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_hasInitialized)
        {
            _hasInitialized = true;
            await LoadData();
        }
    }

    private async Task LoadData()
    {
        activities = await ActivityService.GetAllAsync(); // Loads all activities by default
        activityTypes = await ActivityTypeService.GetAllAsync();
        StateHasChanged();
        // Update chart after state change to ensure DOM is ready
        await Task.Delay(50);
        await UpdateGoalDurationChart();
    }

    private async Task OnDurationChanged(DurationOption duration)
    {
        if (selectedDuration == duration)
            return; // No change needed
            
        selectedDuration = duration;
        StateHasChanged();
        // Small delay to ensure UI is updated before chart update
        await Task.Delay(50);
        await UpdateGoalDurationChart();
    }

    private async Task<(DateTime StartDate, DateTime EndDate)> GetDateRange()
    {
        var now = DateTime.Now;
        
        switch (selectedDuration)
        {
            case DurationOption.Last24Hours:
                var start24h = now.AddHours(-24);
                var end24h = now;
                return (start24h, end24h);
            case DurationOption.Last7Days:
                var start7d = now.AddDays(-7);
                var end7d = now;
                return (start7d, end7d);
            case DurationOption.Week:
                // Get the Monday of the week containing the current date
                var daysToMonday = ((int)now.DayOfWeek - (int)DayOfWeek.Monday + 7) % 7;
                var weekStart = now.AddDays(-daysToMonday).Date;
                var weekEnd = weekStart.AddDays(6).Date.AddHours(23).AddMinutes(59).AddSeconds(59);
                return (weekStart, weekEnd);
            default:
                return (DateTime.MinValue, DateTime.MaxValue);
        }
    }

    private async Task<List<Activity>> GetFilteredActivitiesAsync()
    {
        var (startDate, endDate) = await GetDateRange();
        // Filter activities within the date range (inclusive)
        var filtered = activities.Where(a => a.When >= startDate && a.When <= endDate).ToList();
        return filtered;
    }

    private int? GetGoalAmount(ActivityType activityType)
    {
        return selectedDuration switch
        {
            DurationOption.Last24Hours => activityType.DailyAmount,
            DurationOption.Last7Days => activityType.WeeklyAmount,
            DurationOption.Week => activityType.WeeklyAmount,
            _ => null
        };
    }

    private async Task UpdateGoalDurationChart()
    {
        // Prevent concurrent chart updates
        if (_isUpdatingChart)
        {
            return;
        }
        
        _isUpdatingChart = true;
        
        try
        {
            // Destroy existing chart first
            if (chartInstance != null)
            {
                await JSRuntime.InvokeVoidAsync("chartHelper.destroyChart", chartInstance);
                chartInstance = null;
                // Small delay to ensure chart is fully destroyed
                await Task.Delay(100);
            }

            var filteredActivities = await GetFilteredActivitiesAsync();
            
            // Group activities by type and calculate totals
            var activityData = filteredActivities
                .GroupBy(a => a.ActivityTypeId)
                .Select(g => new
                {
                    ActivityTypeId = g.Key,
                    TotalAmount = g.Sum(a => a.Amount),
                    ActivityType = activityTypes.FirstOrDefault(t => t.Id == g.Key)
                })
                .Where(x => x.ActivityType != null && x.ActivityType.NetBenefit != NetBenefit.None)
                .ToList();

            // Calculate percentages and filter out activities without goals
            var chartData = new List<(string Label, double Percentage, NetBenefit NetBenefit)>();

            foreach (var data in activityData)
            {
                var goalAmount = GetGoalAmount(data.ActivityType!);
                if (goalAmount.HasValue && goalAmount.Value > 0)
                {
                    var percentage = (data.TotalAmount / (double)goalAmount.Value) * 100.0;
                    chartData.Add((GetActivityTypeName(data.ActivityTypeId), percentage, data.ActivityType!.NetBenefit));
                }
            }

            if (chartData.Count == 0)
            {
                // No data to display, chart already destroyed above
                return;
            }

            // Find maximum percentage for y-axis scaling
            var maxPercentage = chartData.Max(d => Math.Abs(d.Percentage));
            if (maxPercentage < 100)
            {
                maxPercentage = 100; // Ensure minimum range of -100 to 100
            }

            var labels = chartData.Select(d => d.Label).ToArray();
            var percentages = chartData.Select(d => d.Percentage).ToArray();
            var netBenefits = chartData.Select(d => d.NetBenefit.ToString()).ToArray();

            chartInstance = await JSRuntime.InvokeAsync<string>(
                "chartHelper.createGoalDurationChart",
                "goalDurationChart",
                labels,
                percentages,
                netBenefits,
                maxPercentage);
        }
        catch
        {
            // Silently handle errors
        }
        finally
        {
            _isUpdatingChart = false;
        }
    }

    private string GetActivityTypeName(int activityTypeId)
    {
        return activityTypes.FirstOrDefault(t => t.Id == activityTypeId)?.Name ?? "Unknown";
    }

    private string GetAmountDisplay(Activity activity)
    {
        var activityType = activityTypes.FirstOrDefault(t => t.Id == activity.ActivityTypeId);
        if (activityType?.Unit != null)
        {
            return $"{activity.Amount} {activityType.Unit}";
        }
        return activity.Amount.ToString();
    }


    private string GetActivityTypeColor(int activityTypeId)
    {
        var type = activityTypes.FirstOrDefault(t => t.Id == activityTypeId);
        return type?.NetBenefit switch
        {
            NetBenefit.Positive => "rgba(40, 167, 69, 0.8)",
            NetBenefit.Negative => "rgba(220, 53, 69, 0.8)",
            _ => "rgba(108, 117, 125, 0.8)"
        };
    }

    private string GetNavigationPath(string path)
    {
        var baseUri = Navigation.BaseUri.TrimEnd('/');
        var normalizedPath = path.TrimStart('/');
        var fullPath = $"{baseUri}/{normalizedPath}";
        return fullPath;
    }

    private void AddNewActivity()
    {
        Navigation.NavigateTo(GetNavigationPath("/activity"));
    }

    private void EditActivity(int id)
    {
        Navigation.NavigateTo(GetNavigationPath($"/activity/{id}"));
    }

    private async Task ExportActivities()
    {
        try
        {
            var jsonData = await ExportImportService.ExportDataAsync();
            var fileName = $"trainer-export-{DateTime.Now:yyyyMMdd-HHmmss}.json";
            
            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, jsonData);
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Export failed: {ex.Message}");
        }
    }

    private async Task ImportActivities()
    {
        // Trigger file input click via JavaScript
        await JSRuntime.InvokeVoidAsync("eval", "document.getElementById('fileInput').click();");
    }

    private async Task HandleFileImport(InputFileChangeEventArgs e)
    {
        try
        {
            using var stream = e.File.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
            using var reader = new StreamReader(stream);
            var jsonData = await reader.ReadToEndAsync();

            await ExportImportService.ImportDataAsync(jsonData);
            await LoadData();
            
            await JSRuntime.InvokeVoidAsync("alert", "Import successful!");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Import failed: {ex.Message}");
        }
    }
}

